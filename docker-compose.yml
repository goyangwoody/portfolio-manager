version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: portfolio_api
    restart: always
    env_file: .env
    # 외부로는 공개하지 않고 nginx 통해 접근 (내부 포트만 노출)
    expose:
      - "8000"
    networks:
      - appnet
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/docs >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

  
  nginx:
    image: nginx:1.27
    container_name: portfolio_nginx
    restart: always
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /srv/app/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - /srv/app/web_build:/usr/share/nginx/html:ro
      - /srv/app/certbot/www:/var/www/certbot:ro
      - /srv/app/certbot/letsencrypt:/etc/letsencrypt:ro
    networks:
      - appnet
  # 인증서 발급/갱신용 사이드카(명령 내릴 때만 사용)
  certbot:
    image: certbot/certbot:latest
    container_name: portfolio_certbot
    # 필요 시에만 실행하므로 평소엔 꺼둬도 됨
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/letsencrypt:/etc/letsencrypt
      - ./certbot/log:/var/log/letsencrypt

    command: -c "sleep infinity"
    networks:
      - appnet

networks:
  appnet:
    driver: bridge
